<html>
<head>
<style>
  label {display:block; width:200px;text-align: right;}
  span,input {margin:5px;}
</style>
<script src="../../node_modules/mithril/mithril.js"></script>
<script src="../../src/circus.js"></script>
<script src="../../src/signal.js"></script>
<script src="../../src/composables.js"></script>
<script src="../../src/mvi.js"></script>
<script src="../../libraries/mithril-circus.js"></script>
</head>
<body>
<script>

  var app = circus.mvi(),
      login = app.signal().and('login','user').httpPOST('http://login'),
      register = app.signal().and('register','user','details').httpPOST('/register'),
      specials = app.signal().sample(login,register).httpGET('/specials/:sessionId'),
      init = app.signal(),
  
  var model = app.model()
      .feed(login,register)
      .merge(login,register,specials,init)

  var view = app.view().map(loginOrRegister)

  function loginOrRegister(model,error) {
    return m('div', [
      m('h1', 'Please Login'),
      input('Email','email','user'),
      input('Password','password','user','password'),
      !model.data.register &&  button('Log in', 'login'),
      input('Not registered?', 'register', false, 'checkbox'),
      model.data.register &&  m('div' [
        input('Confirm','confirm',false,'password'),
        input('Log in','login', false,'button'),
        dropdown('Title','title',['Mr','Mrs']),
        input('First Name', 'firstName', 'details'),
        input('Last Name', 'lastName', 'details'),
        input('Address','address')
      ])
    ])

    // memo helpers to build markup and bind model and intentions
    function input(label, name, ns, type) {
      var errorMsg = circus.lens(error,ns,name),
          value = circus.lens(model,ns,name),
          intention = circus.lens(intentions,ns,name).value

      return m('label',[
        label, 
        m('input', {
          type: type || 'text',
          onchange:m.withAttr('value',intention),
          value:value
        }),
        errorMsg && m('span.error', errorMsg)
      ])
    }
    function button(label,name){
      return m('button', {onclick:view.click(circus.lens(intentions,name),true)},[label])
    }
    function dropdown(label, name, data) {
      return m('label',[
        label || name, 
        m('select', [
          data.map(function(d){
            return m('option', d)
          })
        ])
      ])
    }
    
  }

  // construct the intention circuit using a signal block of named channels.
  // each channel gets its own binding in the view
  var intent = app.intent(),
      strength = app.signal(),
      password = required().then(strengthTest),
      intentions = {
        user: {
          email: required().error(formed),
          password: password
        },
        login:app.signal().pulse(),
        register: app.signal().pulse(),
        strength: strength,
        confirm: app.signal().then(match),
        details: {
          title: required(),
          firstName: required(),
          lastName: required(),
          address: {
            line1: required(),
            line2: app.signal(),
            town: required(),
            county: required(),
            country: required()
          }
        }
      }

  intent.join(intentions)

  // create some helper functions to simplify the circuit definition
  function required(msg) {
    return app.signal().error(function(v){return !v && (msg ||'required')})
  }

  var email = /\S+@\S+\.\S+/i
  function formed(v) {
    return !email.test(v) && 'invalid email'
  }
  function match(confirm) {
    return confirm.sample(password,function(v){
      if (v[0]!==v[1]) confirm.error('password does not match')
      return true
    })
  }
  function strengthTest(password){
    return password.feed(strength,function(v){
      var score = v.length
      if (score < 6) strength.error('password too weak')
      return score
    })
  }

  // kick off
  var app = circus.fold(model, view, intent)
  init.value(intent.stamp())

  m.route(document.body,'/login', {
    '/login': app,
    '/specials': circus.fold(model, specials, intent)
  })

</script>
</body>
</html>